#!/usr/bin/env python3
"""
ü§ñ Telegram Bot Webhook Server
–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /test –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
"""

from flask import Flask, request, jsonify
import os
import logging
import requests

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN')
PORT = int(os.environ.get('PORT', 5000))

def send_telegram_message(chat_id, text):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram"""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {
        'chat_id': chat_id,
        'text': text,
        'parse_mode': 'HTML'
    }
    
    try:
        response = requests.post(url, json=payload, timeout=5)
        response.raise_for_status()
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return False

@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>ü§ñ Telegram Bot Webhook</title>
        <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            .container { max-width: 600px; margin: 0 auto; }
            h1 { color: #0088cc; }
            .status { background: #f0f8ff; padding: 20px; border-radius: 10px; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ü§ñ Telegram Bot Webhook</h1>
            <div class="status">
                <p>‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç</p>
                <p>üìû –≠–Ω–¥–ø–æ–∏–Ω—Ç –≤–µ–±—Ö—É–∫–∞: <code>/webhook</code></p>
                <p>‚ö° –ö–æ–º–∞–Ω–¥–∞: <code>/test</code></p>
                <p>üí¨ –û—Ç–≤–µ—Ç: <code>"—Ç–µ—Å—Ç —Å—Ä–∞–±–æ—Ç–∞–ª!"</code></p>
            </div>
            <p>–ù–∞—Å—Ç—Ä–æ–π –≤–µ–±—Ö—É–∫ –≤ Telegram:</p>
            <code>https://api.telegram.org/bot[–í–ê–®_–¢–û–ö–ï–ù]/setWebhook?url=[URL_–≠–¢–û–ì–û_–°–ï–†–í–ï–†–ê]/webhook</code>
        </div>
    </body>
    </html>
    """

@app.route('/webhook', methods=['POST'])
def webhook():
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram"""
    try:
        data = request.get_json()
        logger.info(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: {data}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è
        if 'message' in data:
            message = data['message']
            chat_id = message['chat']['id']
            text = message.get('text', '').strip()
            
            logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {chat_id}: {text}")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É /test
            if text == '/test':
                logger.info(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∫–æ–º–∞–Ω–¥—É /test –æ—Ç {chat_id}")
                success = send_telegram_message(chat_id, "—Ç–µ—Å—Ç —Å—Ä–∞–±–æ—Ç–∞–ª! üéâ")
                
                if success:
                    logger.info(f"–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}")
                    return jsonify({'status': 'ok', 'message': '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'})
                else:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}")
                    return jsonify({'status': 'error', 'message': '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'}), 500
            
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
            elif text == '/start':
                send_telegram_message(chat_id, "ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!\n\n–ö–æ–º–∞–Ω–¥—ã:\n/test - —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞")
                return jsonify({'status': 'ok'})
        
        return jsonify({'status': 'ok', 'message': '–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ'})
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500

@app.route('/health', methods=['GET'])
def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞"""
    return jsonify({'status': 'healthy', 'service': 'telegram-bot-webhook'})

if __name__ == '__main__':
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
    logger.info(f"ü§ñ –¢–æ–∫–µ–Ω –±–æ—Ç–∞: {'–£–°–¢–ê–ù–û–í–õ–ï–ù' if BOT_TOKEN else '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}")
    
    if not BOT_TOKEN:
        logger.warning("‚ö†Ô∏è  BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è.")
    
    app.run(host='0.0.0.0', port=PORT, debug=False)
